{"version":3,"file":"resop.js","sources":["../../../src/responsiveness/resop.ts"],"sourcesContent":["import { Devices, ResponsiveValue, TrulyResponsiveValue } from \"../types\";\n\ntype Values = { [key: string]: any };\n\nexport function resop<\n  Input extends Record<string, ResponsiveValue<unknown>>,\n  ScalarResult extends Record<string, unknown>\n>(\n  config: Input,\n  callback: (\n    scalarInput: Scalar<Input>,\n    breakpointIndex: string\n  ) => ScalarResult,\n  devices: Devices\n): Responsify<ScalarResult> {\n  // Decompose config into scalar configs\n  const scalarConfigs: Record<string, Scalar<Input>> = {};\n\n  devices.forEach((device) => {\n    scalarConfigs[device.id] = scalarizeConfig(config, device.id);\n  });\n\n  const scalarOutputs: Record<string, any> = {};\n\n  // run callback for scalar configs\n  devices.forEach((device) => {\n    scalarOutputs[device.id] = callback(scalarConfigs[device.id], device.id);\n  });\n\n  return squashCSSResults(scalarOutputs, devices);\n}\n\nfunction squashCSSResults(\n  scalarValues: { [key: string]: any },\n  devices: Devices,\n  disableNesting?: boolean\n): any {\n  // Let's check whether scalarValues represent object (for nesting) or a scalar value.\n  let objectsNum = 0;\n  let noObjectsNum = 0;\n  let arraysNum = 0;\n\n  for (const breakpointName in scalarValues) {\n    const val = scalarValues[breakpointName];\n\n    if (Array.isArray(val) && !disableNesting) {\n      arraysNum++;\n    } else if (\n      typeof val === \"object\" &&\n      val !== null &&\n      !Array.isArray(val) &&\n      !disableNesting\n    ) {\n      objectsNum++;\n    } else if (val !== null && val !== undefined) {\n      noObjectsNum++;\n    }\n  }\n\n  // Only one flag can be > 0!!! Otherwise breakpoints return incompatible types\n  if (\n    (objectsNum > 0 && (noObjectsNum > 0 || arraysNum > 0)) ||\n    (arraysNum > 0 && (noObjectsNum > 0 || objectsNum > 0)) ||\n    (noObjectsNum > 0 && (arraysNum > 0 || objectsNum > 0))\n  ) {\n    throw new Error(\n      \"This shouldn't happen. Mismatched types for different breakpoints!!!\"\n    );\n  }\n\n  if (arraysNum > 0) {\n    let biggestArrayLength = 0;\n\n    for (const breakpoint in scalarValues) {\n      biggestArrayLength = Math.max(\n        biggestArrayLength,\n        scalarValues[breakpoint].length\n      ); // {...allKeysObject, ...scalarValues[breakpoint]};\n    }\n\n    const ret: any[] = [];\n\n    for (let i = 0; i < biggestArrayLength; i++) {\n      const newScalarValues: { [key: string]: any } = {};\n\n      for (const breakpoint in scalarValues) {\n        let value: any = undefined;\n\n        if (scalarValues[breakpoint]) {\n          value = scalarValues[breakpoint][i];\n        }\n\n        newScalarValues[breakpoint] = value;\n      }\n\n      ret[i] = squashCSSResults(newScalarValues, devices);\n    }\n\n    return ret;\n  }\n\n  // If object -> recursion\n  if (objectsNum > 0) {\n    // allKeys is the object that has all the keys from all the scalar configs\n    let allKeysObject: { [key: string]: null } = {};\n\n    /**\n     * Scalar values are like:\n     *\n     * {\n     *    b1: { a: 10, b: 20 }\n     *    b2: { a: 100, c: 300 }\n     * }\n     */\n\n    for (const breakpoint in scalarValues) {\n      allKeysObject = { ...allKeysObject, ...scalarValues[breakpoint] };\n    }\n\n    // scalarValues.forEach(scalarConfig => {\n    //     allKeysObject = {...allKeysObject, ...scalarConfig};\n    // });\n\n    const allKeys = Object.keys(allKeysObject);\n    const ret: Values = {};\n\n    /**\n     * All keys are like: ['a', 'b', 'c']\n     *\n     * All used keys across all breakpoints\n     */\n\n    allKeys.forEach((key) => {\n      const newScalarValues: { [key: string]: any } = {};\n\n      for (const breakpoint in scalarValues) {\n        let value: any = undefined;\n\n        if (scalarValues[breakpoint]) {\n          value = scalarValues[breakpoint][key];\n        }\n\n        newScalarValues[breakpoint] = value;\n      }\n      /**\n       * newScalarValues values are like:\n       *\n       * For key 'a':\n       * {\n       *      b1: 10,\n       *      b2: 100\n       * }\n       *\n       * For key 'b':\n       * {\n       *     b1: 20,\n       *     b2: undefined\n       * }\n       *\n       */\n\n      /**\n       * For fonts we don't want nesting + recursion. We want entire object to be passed to results.\n       *\n       * Later, renderer must know how to render xfont property :)\n       *\n       * Otherwise, media query conflicts arise and bad values are set.\n       */\n      ret[key] = squashCSSResults(newScalarValues, devices, key === \"xfont\");\n    });\n\n    return ret;\n  }\n\n  // Here we are sure we have scalar value, not some object to be nested. We must do 2 things:\n  // - add \"unset\" instead of null / undefined\n  // - create ResponsiveValue and normalize\n\n  for (const key in scalarValues) {\n    if (scalarValues[key] === undefined || scalarValues[key] === null) {\n      scalarValues[key] = \"unset\";\n    }\n  }\n\n  // Values (non-objects -> no nesting)\n  return responsiveValueNormalize({ ...scalarValues, $res: true }, devices);\n}\n\nfunction responsiveValueForceGet<T>(\n  value: ResponsiveValue<T>,\n  deviceId: string\n): T {\n  if (isTrulyResponsiveValue(value)) {\n    if (value[deviceId] === undefined) {\n      const error = `You called responsiveValueForceGet with value ${JSON.stringify(\n        value\n      )} and deviceId: ${deviceId}. Value undefined.`;\n      throw new Error(error);\n    }\n    return value[deviceId] as T;\n  }\n  return value;\n}\n\nfunction isTrulyResponsiveValue<T>(\n  x: ResponsiveValue<T>\n): x is TrulyResponsiveValue<T> {\n  return (\n    typeof x === \"object\" &&\n    x !== null &&\n    !Array.isArray(x) &&\n    (x as TrulyResponsiveValue<T>).$res === true\n  );\n}\n\nfunction responsiveValueNormalize<T>(\n  arg: ResponsiveValue<T>,\n  devices: Devices\n): ResponsiveValue<T> {\n  if (!isTrulyResponsiveValue(arg)) {\n    return arg;\n  }\n\n  let previousVal: any = undefined;\n\n  const ret: TrulyResponsiveValue<any> = {\n    $res: true,\n  };\n\n  let numberOfDefinedValues = 0;\n\n  for (let i = devices.length - 1; i >= 0; i--) {\n    const breakpoint = devices[i].id;\n    const val = arg[breakpoint];\n\n    // TODO: if values are objects, it's to do\n    if (typeof val === \"object\" && val !== null) {\n      if (JSON.stringify(val) !== JSON.stringify(previousVal)) {\n        ret[breakpoint] = val;\n        previousVal = val;\n        numberOfDefinedValues++;\n      }\n    } else {\n      if (val !== undefined && val !== previousVal) {\n        ret[breakpoint] = val;\n        previousVal = val;\n        numberOfDefinedValues++;\n      }\n    }\n\n    // [x, null, null, y] => [x, y]\n    if (i < devices.length - 1) {\n      const nextBreakpoint = devices[i + 1].id;\n\n      if (\n        numberOfDefinedValues === 1 &&\n        ret[breakpoint] === undefined &&\n        ret[nextBreakpoint] !== undefined\n      ) {\n        ret[breakpoint] = ret[nextBreakpoint];\n        delete ret[nextBreakpoint];\n      }\n    }\n  }\n\n  if (numberOfDefinedValues === 1) {\n    return ret[devices[0].id];\n  }\n\n  return ret;\n}\n\ntype UnwrapResponsiveValue<T> = T extends ResponsiveValue<infer Value>\n  ? Value\n  : never;\n\ntype Scalar<Input extends Record<string, ResponsiveValue<unknown>>> = {\n  [key in keyof Input]: UnwrapResponsiveValue<Input[key]>;\n};\n\ntype Responsify<T extends Record<string, unknown>> = {\n  [key in keyof T]: T[key] extends Record<string, unknown>\n    ? Responsify<T[key]>\n    : ResponsiveValue<T[key]>;\n};\n\nfunction scalarizeConfig(config: Values, breakpoint: string): any {\n  const ret: Record<string, any> = {};\n\n  for (const prop in config) {\n    ret[prop] = responsiveValueForceGet(config[prop], breakpoint);\n  }\n\n  return ret;\n}\n"],"names":["resop","config","callback","devices","scalarConfigs","forEach","device","id","scalarizeConfig","scalarOutputs","squashCSSResults","scalarValues","disableNesting","objectsNum","noObjectsNum","arraysNum","breakpointName","val","Array","isArray","undefined","Error","biggestArrayLength","breakpoint","Math","max","length","ret","i","newScalarValues","value","allKeysObject","allKeys","Object","keys","key","responsiveValueNormalize","$res","responsiveValueForceGet","deviceId","isTrulyResponsiveValue","error","JSON","stringify","x","arg","previousVal","numberOfDefinedValues","nextBreakpoint","prop"],"mappings":"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"}