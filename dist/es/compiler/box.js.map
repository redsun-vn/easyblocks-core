{"version":3,"file":"box.js","sources":["../../../src/compiler/box.ts"],"sourcesContent":["import { DeviceRange, Devices } from \"../types\";\nimport { flattenResponsiveStyles } from \"./flattenResponsiveStyles\";\n\nfunction compileBox(input: { [key: string]: any }, devices: Devices) {\n  if (typeof input === \"object\" && input.$res) {\n    const ret: { [key: string]: any } = {};\n\n    for (const key in input) {\n      if (key !== \"$res\") {\n        ret[\"@\" + key] = input[key];\n      }\n    }\n    return ret;\n  } else if (typeof input === \"object\" && input !== null) {\n    const ret: { [key: string]: any } = {};\n\n    /**\n     * FIXME: there's a bug here!!!\n     *\n     * I don't know what to do about it. We add items in a correct order to the ret object, and JS should keep this order\n     * but it clearly doesn't work and order gets broken. This breaks where \"unset\" is set in CSS and hence, inheritance is broken.\n     *\n     * This can be fixed by adding \"specific media queries\" (from - to) here. It's gonna work.\n     */\n\n    for (const key in input) {\n      const val = input[key];\n\n      if (typeof val === \"object\" && val.$res === true) {\n        // const maxBreakpoint = responsiveValueGetMaxDefinedBreakpoint(val, devices);\n\n        let isFirst = true;\n\n        for (let i = devices.length - 1; i >= 0; i--) {\n          const breakpoint = devices[i].id;\n\n          if (val[breakpoint] === null || val[breakpoint] === undefined) {\n            continue;\n          }\n\n          if (isFirst) {\n            ret[key] = val[breakpoint];\n            isFirst = false;\n          } else {\n            if (!ret[\"@\" + breakpoint]) {\n              ret[\"@\" + breakpoint] = {};\n            }\n\n            ret[\"@\" + breakpoint][key] = val[breakpoint];\n          }\n        }\n\n        continue;\n      }\n\n      ret[key] = compileBox(val, devices);\n    }\n\n    return ret;\n  }\n  return input;\n}\n\nfunction getBoxStyles(styles: { [key: string]: any }, devices: Devices) {\n  const flattenStyles = flattenResponsiveStyles(styles);\n  const ret: Record<string, any> = {};\n\n  // First copy all the non-responsive values\n  for (const key in flattenStyles) {\n    if (!key.startsWith(\"@\") && key !== \"__isBox\" && key !== \"__hash\") {\n      ret[key] = flattenStyles[key];\n    }\n  }\n\n  // now copy breakpoint values in correct order\n  for (let i = devices.length - 1; i >= 0; i--) {\n    const device = devices[i];\n    const breakpoint = device.id;\n\n    // correct order!\n    if (flattenStyles[\"@\" + breakpoint]) {\n      const resolvedKey = resolveDeviceIdToMediaQuery(device);\n      ret[resolvedKey] = flattenStyles[\"@\" + breakpoint];\n    }\n  }\n\n  return ret;\n}\n\nfunction resolveDeviceIdToMediaQuery(device: DeviceRange) {\n  return `@media (max-width: ${device.breakpoint! - 1}px)`;\n}\n\nexport { compileBox, getBoxStyles };\n"],"names":["compileBox","input","devices","$res","ret","key","val","isFirst","i","length","breakpoint","id","undefined","getBoxStyles","styles","flattenStyles","flattenResponsiveStyles","startsWith","device","resolvedKey","resolveDeviceIdToMediaQuery"],"mappings":"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"}