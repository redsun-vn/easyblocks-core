{"version":3,"file":"useTextValue.js","sources":["../../../../src/compiler/builtins/useTextValue.ts"],"sourcesContent":["import { cleanString } from \"@/utils\";\r\nimport debounce from \"lodash/debounce\";\r\nimport React from \"react\";\r\nimport { Locale, getFallbackForLocale } from \"../../locales\";\r\n\r\nexport function useTextValue(\r\n  value: any,\r\n  onChange: any,\r\n  locale: string,\r\n  locales: Array<Locale>,\r\n  defaultPlaceholder?: string,\r\n  normalize?: (x: string) => string | null\r\n) {\r\n  const isExternal = typeof value === \"object\" && value !== null;\r\n  const fallbackValue = isExternal\r\n    ? getFallbackForLocale(value.value, locale, locales)\r\n    : undefined;\r\n\r\n  const valueFromProps = (() => {\r\n    if (isExternal) {\r\n      let displayedValue = value.value?.[locale];\r\n\r\n      if (typeof displayedValue !== \"string\") {\r\n        displayedValue = fallbackValue ?? \"\";\r\n      }\r\n\r\n      return displayedValue;\r\n    }\r\n    return value ?? \"\";\r\n  })();\r\n\r\n  const previousValue = React.useRef(valueFromProps);\r\n\r\n  const [localInputValue, setLocalInputValue] = React.useState(valueFromProps);\r\n\r\n  function saveNewValue(newValue: string | null) {\r\n    if (isExternal) {\r\n      const newExternalValue = {\r\n        ...value,\r\n        value: {\r\n          ...value.value,\r\n          [locale]: newValue,\r\n        },\r\n      };\r\n\r\n      onChange(newExternalValue);\r\n    } else {\r\n      onChange(newValue);\r\n    }\r\n  }\r\n\r\n  const onChangeDebounced = React.useCallback(\r\n    debounce((newValue: string) => {\r\n      // If normalization is on, we shouldn't save on change\r\n      if (normalize) {\r\n        return;\r\n      }\r\n\r\n      saveNewValue(newValue);\r\n    }, 500),\r\n    [isExternal]\r\n  );\r\n\r\n  function handleBlur() {\r\n    onChangeDebounced.cancel();\r\n\r\n    let newValue = localInputValue;\r\n\r\n    if (normalize) {\r\n      const normalized = normalize(newValue);\r\n      if (normalized === null) {\r\n        newValue = previousValue.current;\r\n      } else {\r\n        newValue = normalized;\r\n        previousValue.current = localInputValue;\r\n      }\r\n    }\r\n\r\n    setLocalInputValue(newValue);\r\n\r\n    if (isExternal) {\r\n      if (newValue.trim() === \"\") {\r\n        saveNewValue(null);\r\n        setLocalInputValue(fallbackValue ?? \"\");\r\n      } else {\r\n        saveNewValue(newValue);\r\n      }\r\n    } else {\r\n      if (value !== newValue) {\r\n        saveNewValue(newValue);\r\n      }\r\n    }\r\n  }\r\n\r\n  function handleChange(\r\n    event: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>\r\n  ) {\r\n    setLocalInputValue(event.target.value);\r\n    onChangeDebounced(event.target.value);\r\n  }\r\n\r\n  // Sync local value with value from the config if the field value has been\r\n  // changed from outside\r\n  React.useEffect(() => {\r\n    setLocalInputValue(valueFromProps);\r\n  }, [valueFromProps]);\r\n\r\n  const style: any = {\r\n    opacity: localInputValue === fallbackValue ? 0.5 : 1,\r\n  };\r\n\r\n  return {\r\n    onChange: handleChange,\r\n    onBlur: handleBlur,\r\n    value: cleanString(localInputValue),\r\n    style,\r\n    placeholder: defaultPlaceholder ?? \"Enter text\",\r\n  };\r\n}\r\n"],"names":["useTextValue","value","onChange","locale","locales","defaultPlaceholder","normalize","isExternal","fallbackValue","getFallbackForLocale","undefined","valueFromProps","displayedValue","previousValue","React","useRef","localInputValue","setLocalInputValue","useState","saveNewValue","newValue","newExternalValue","onChangeDebounced","useCallback","debounce","handleBlur","cancel","normalized","current","trim","handleChange","event","target","useEffect","style","opacity","onBlur","cleanString","placeholder"],"mappings":"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"}