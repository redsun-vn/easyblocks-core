{"version":3,"file":"resourcesUtils.cjs","sources":["../../src/resourcesUtils.ts"],"sourcesContent":["import { isEmptyRenderableContent } from \"./checkers\";\r\nimport { responsiveValueMap } from \"./responsiveness\";\r\nimport type {\r\n  ExternalData,\r\n  ExternalReference,\r\n  ExternalReferenceNonEmpty,\r\n  ExternalSchemaProp,\r\n  FetchOutputCompoundResources,\r\n  NonNullish,\r\n  ResponsiveValue,\r\n} from \"./types\";\r\n\r\nexport function getExternalValue(\r\n  externalDataValue: ExternalData[string]\r\n): NonNullish | undefined {\r\n  if (\"error\" in externalDataValue) {\r\n    return;\r\n  }\r\n\r\n  return externalDataValue.value;\r\n}\r\n\r\nexport function isLocalTextReference(\r\n  resource: { id: string | null },\r\n  type: string\r\n) {\r\n  if (resource.id === null) {\r\n    return false;\r\n  }\r\n\r\n  return type === \"text\" && resource.id.startsWith(\"local.\");\r\n}\r\n\r\nexport function getExternalReferenceLocationKey(\r\n  configId: string,\r\n  fieldName: string,\r\n  deviceId?: string\r\n) {\r\n  let resourceId = `${configId}.${fieldName}`;\r\n\r\n  if (deviceId) {\r\n    resourceId += `.${deviceId}`;\r\n  }\r\n\r\n  return resourceId;\r\n}\r\n\r\nexport function getResolvedExternalDataValue(\r\n  externalData: ExternalData,\r\n  configId: string,\r\n  fieldName: string,\r\n  value: ExternalReferenceNonEmpty\r\n) {\r\n  const externalReferenceLocationKey =\r\n    typeof value.id === \"string\" && value.id.startsWith(\"$.\")\r\n      ? value.id\r\n      : getExternalReferenceLocationKey(configId, fieldName);\r\n\r\n  const externalValue = externalData[externalReferenceLocationKey];\r\n\r\n  if (externalValue === undefined || \"error\" in externalValue) {\r\n    return;\r\n  }\r\n\r\n  return externalValue;\r\n}\r\n\r\nexport function resolveExternalValue(\r\n  responsiveResource: ResponsiveValue<ExternalReference>,\r\n  configId: string,\r\n  schemaProp: ExternalSchemaProp,\r\n  externalData: ExternalData\r\n): ResponsiveValue<NonNullish | undefined> | undefined {\r\n  return responsiveValueMap(responsiveResource, (r: any, breakpointIndex) => {\r\n    if (r.id) {\r\n      // If resource field has `key` defined and its `id` starts with \"$.\", it means that it's a reference to the\r\n      // root resource and we need to look for the resource with the same id as the root resource.\r\n      const locationKey =\r\n        r.key && typeof r.id === \"string\" && r.id.startsWith(\"$.\")\r\n          ? r.id\r\n          : getExternalReferenceLocationKey(\r\n            configId,\r\n            schemaProp.prop,\r\n            breakpointIndex\r\n          );\r\n      const externalDataValue = externalData[locationKey];\r\n\r\n      let resourceValue: ReturnType<typeof getExternalValue>;\r\n\r\n      if (externalDataValue) {\r\n        resourceValue = getExternalValue(externalDataValue);\r\n      }\r\n\r\n      if (\r\n        externalDataValue === undefined ||\r\n        isEmptyRenderableContent(resourceValue)\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      if (\"error\" in externalDataValue) {\r\n        return;\r\n      }\r\n\r\n      if (isCompoundExternalDataValue(externalDataValue)) {\r\n        if (!r.key) {\r\n          return;\r\n        }\r\n\r\n        const resolvedResourceValue = externalDataValue.value[r.key].value;\r\n\r\n        if (!resolvedResourceValue) {\r\n          return;\r\n        }\r\n\r\n        return resolvedResourceValue;\r\n      }\r\n\r\n      return resourceValue;\r\n    }\r\n\r\n    return;\r\n  });\r\n}\r\n\r\nexport function isCompoundExternalDataValue(\r\n  value: ExternalData[string]\r\n): value is FetchOutputCompoundResources[string] {\r\n  return (\r\n    (\"type\" in value && value.type === \"object\" && \"value\" in value) ||\r\n    \"error\" in value\r\n  );\r\n}\r\n"],"names":["getExternalValue","externalDataValue","value","isLocalTextReference","resource","type","id","startsWith","getExternalReferenceLocationKey","configId","fieldName","deviceId","resourceId","getResolvedExternalDataValue","externalData","externalReferenceLocationKey","externalValue","undefined","resolveExternalValue","responsiveResource","schemaProp","responsiveValueMap","r","breakpointIndex","locationKey","key","prop","resourceValue","isEmptyRenderableContent","isCompoundExternalDataValue","resolvedResourceValue"],"mappings":"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"}