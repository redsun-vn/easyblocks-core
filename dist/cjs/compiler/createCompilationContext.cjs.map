{"version":3,"file":"createCompilationContext.cjs","sources":["../../../src/compiler/createCompilationContext.ts"],"sourcesContent":["import { responsiveValueMap } from \"../responsiveness\";\r\nimport { parseSpacing } from \"../spacingToPx\";\r\nimport {\r\n  Config,\r\n  ConfigDeviceRange,\r\n  ContextParams,\r\n  CustomTypeDefinition,\r\n  Devices,\r\n  NoCodeComponentDefinition,\r\n  ResponsiveValue,\r\n  Spacing,\r\n  SchemaProp,\r\n  TokenTypeDefinition,\r\n  ExternalTypeDefinition,\r\n  ThemeTokenValue,\r\n} from \"../types\";\r\nimport { richTextEditableComponent } from \"./builtins/$richText/$richText\";\r\nimport { richTextBlockElementEditableComponent } from \"./builtins/$richText/$richTextBlockElement/$richTextBlockElement\";\r\nimport { richTextLineElementEditableComponent } from \"./builtins/$richText/$richTextLineElement/$richTextLineElement\";\r\nimport { richTextPartEditableComponent } from \"./builtins/$richText/$richTextPart/$richTextPart\";\r\nimport { textEditableComponent } from \"./builtins/$text/$text\";\r\nimport { DEFAULT_DEVICES } from \"./devices\";\r\nimport { themeScalarValueToResponsiveValue } from \"./themeValueToResponsiveValue\";\r\nimport {\r\n  CompilationContextCustomTypeDefinition,\r\n  CompilationContextType,\r\n  Theme,\r\n} from \"./types\";\r\nimport { validateColor } from \"./validate-color\";\r\n\r\nfunction normalizeSpace(\r\n  space: ResponsiveValue<number | string>\r\n): ResponsiveValue<Spacing> {\r\n  return responsiveValueMap(space, (val) => {\r\n    if (typeof val === \"number\") {\r\n      return `${val}px`;\r\n    }\r\n\r\n    return val;\r\n  });\r\n}\r\n\r\nfunction prepareDevices(configDevices: Config[\"devices\"]): Devices {\r\n  const devices: Devices = []; // let's make devices copy\r\n  DEFAULT_DEVICES.forEach((defaultDevice) => {\r\n    devices.push({\r\n      ...defaultDevice,\r\n    });\r\n  });\r\n\r\n  if (configDevices) {\r\n    devices.forEach((device, index) => {\r\n      const configDevice: ConfigDeviceRange | undefined = (\r\n        configDevices as any\r\n      )[device.id];\r\n\r\n      if (configDevice) {\r\n        device.w = configDevice.w ?? device.w;\r\n        device.h = configDevice.h !== undefined ? configDevice.h : device.h;\r\n        device.hidden = configDevice.hidden ?? device.hidden;\r\n\r\n        if (configDevice.startsFrom && index > 0) {\r\n          const previousDevice = devices[index - 1];\r\n          previousDevice.breakpoint = configDevice.startsFrom;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  return devices;\r\n}\r\n\r\nexport function createCompilationContext(\r\n  config: Config,\r\n  contextParams: ContextParams,\r\n  rootComponentId: string\r\n): CompilationContextType {\r\n  const devices = prepareDevices(config.devices);\r\n  const mainDevice = devices.find((x) => x.isMain);\r\n\r\n  if (!mainDevice) {\r\n    throw new Error(`Missing main device in devices config.`);\r\n  }\r\n\r\n  const { space, ...customTokens } = config.tokens ?? {};\r\n\r\n  const theme: Theme = {\r\n    space: {},\r\n  };\r\n\r\n  // TODO: allow for custom breakpoints!!! What happens with old ones when the new ones show up?\r\n\r\n  if (space) {\r\n    space.forEach((space) => {\r\n      let val = space.value;\r\n\r\n      // If value is \"vw\" and is not responsive then we should responsify it.\r\n      // Why? Because responsive token behaves differently from non-responsive in terms of auto.\r\n      // Responsive token automatically \"fills\" all the breakpoints.\r\n      // If someone does 10vw it is responsive in nature, it's NEVER a scalar.\r\n      if (typeof val === \"string\" && parseSpacing(val).unit === \"vw\") {\r\n        val = { $res: true, [mainDevice.id]: val };\r\n      }\r\n\r\n      theme.space[space.id] = {\r\n        value: normalizeSpace(themeScalarValueToResponsiveValue(val, devices)),\r\n        isDefault: space.isDefault ?? false,\r\n        label: space.label,\r\n      };\r\n    });\r\n  }\r\n\r\n  const types = {\r\n    ...createCustomTypes(config.types),\r\n    ...createBuiltinTypes(),\r\n  };\r\n\r\n  const allTypeIds = Object.keys(types);\r\n\r\n  Object.entries(customTokens).forEach(([id, tokens]) => {\r\n    const type = Object.values(types).find(\r\n      (type) => type.type === \"token\" && type.token === id\r\n    ) as TokenTypeDefinition;\r\n\r\n    if (!type) {\r\n      throw new Error(\r\n        `Can't find a matching type for a token \"${id}\" (found in Config.tokens)`\r\n      );\r\n    }\r\n\r\n    theme[id] = Object.fromEntries<ThemeTokenValue<any>>(\r\n      tokens.map((token) => {\r\n        if (type.validate) {\r\n          if (type.validate(token.value) !== true) {\r\n            throw new Error(\r\n              `The value for token \"${id}.${token.id}\" (${token.value}) is incorrect. The validation function for its corresponding type must return 'true'. `\r\n            );\r\n          }\r\n        }\r\n\r\n        return [\r\n          token.id,\r\n          {\r\n            label: token.label,\r\n            value: token.value,\r\n            isDefault: token.isDefault ?? false,\r\n          },\r\n        ];\r\n      })\r\n    );\r\n  });\r\n\r\n  const components: Array<NoCodeComponentDefinition<any, any>> = [\r\n    textEditableComponent,\r\n    richTextEditableComponent,\r\n    richTextBlockElementEditableComponent,\r\n    richTextLineElementEditableComponent,\r\n    richTextPartEditableComponent,\r\n    {\r\n      id: \"@easyblocks/missing-component\",\r\n      label: \"Missing component\",\r\n      schema: [\r\n        {\r\n          prop: \"error\",\r\n          type: \"string\",\r\n          visible: false,\r\n        },\r\n      ],\r\n    },\r\n  ];\r\n\r\n  const rootComponent = (config.components ?? []).find(\r\n    (component) => component.id === rootComponentId\r\n  );\r\n\r\n  if (!rootComponent) {\r\n    throw new Error(\r\n      `createCompilationContext: rootComponentId \"${rootComponentId}\" doesn't exist in config.components`\r\n    );\r\n  }\r\n\r\n  if (rootComponent.rootParams && rootComponent.rootParams.length > 0) {\r\n    ensureDocumentDataWidgetForExternalTypes(types);\r\n  }\r\n\r\n  const builtinTypes = [\r\n    \"string\",\r\n    \"number\",\r\n    \"boolean\",\r\n    \"select\",\r\n    \"radio-group\",\r\n    \"text\",\r\n    \"component\",\r\n    \"component-collection\",\r\n    \"component-collection-localised\",\r\n    \"position\",\r\n  ];\r\n\r\n  // Validate if components have correct types\r\n  if (config.components) {\r\n    config.components.forEach((component) => {\r\n      if (component.schema) {\r\n        component.schema.forEach((prop) => {\r\n          if (builtinTypes.includes(prop.type)) {\r\n            return;\r\n          }\r\n\r\n          if (!allTypeIds.includes(prop.type)) {\r\n            throw new Error(\r\n              `The field \"${component.id}.${prop.prop}\" has an unrecognized type: \"${prop.type}\". Custom types can be added in Config.types object`\r\n            );\r\n          }\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  if (config.components) {\r\n    components.push(\r\n      ...(config.components ?? []).map((component) => {\r\n        // For root component with rootParams we should create special param types and move params to schema props\r\n        if (component.id === rootComponent.id && rootComponent.rootParams) {\r\n          const paramSchemaProps: SchemaProp[] = [];\r\n\r\n          rootComponent.rootParams.forEach((param) => {\r\n            const typeName = \"param__\" + param.prop;\r\n\r\n            types[typeName] = {\r\n              type: \"external\",\r\n              widgets: param.widgets,\r\n            };\r\n\r\n            paramSchemaProps.push({\r\n              prop: param.prop,\r\n              label: param.label,\r\n              type: typeName,\r\n              group: \"Parameters\",\r\n              optional: true,\r\n            });\r\n          });\r\n\r\n          return {\r\n            ...component,\r\n            schema: [...paramSchemaProps, ...component.schema],\r\n          };\r\n        }\r\n\r\n        return component;\r\n      })\r\n    );\r\n  }\r\n\r\n  if (!config.locales) {\r\n    throw new Error(\r\n      `Required property config.locales doesn't exist in your config.`\r\n    );\r\n  }\r\n\r\n  if (\r\n    config.locales.find((l) => l.code === contextParams.locale) === undefined\r\n  ) {\r\n    throw new Error(\r\n      `You passed locale \"${contextParams.locale}\" which doesn't exist in your config.locales`\r\n    );\r\n  }\r\n\r\n  const compilationContext: CompilationContextType = {\r\n    devices,\r\n    theme,\r\n    definitions: {\r\n      components,\r\n    },\r\n    types,\r\n    mainBreakpointIndex: mainDevice.id,\r\n    contextParams,\r\n    locales: config.locales,\r\n    rootComponent,\r\n  };\r\n\r\n  return compilationContext;\r\n}\r\n\r\nfunction createCustomTypes(\r\n  types: Record<string, CustomTypeDefinition> | undefined\r\n): Record<string, CompilationContextCustomTypeDefinition> {\r\n  if (!types) {\r\n    return {};\r\n  }\r\n\r\n  return Object.fromEntries(\r\n    Object.entries(types).map(([id, definition]) => {\r\n      if (definition.type === \"external\") {\r\n        return [\r\n          id,\r\n          {\r\n            ...definition,\r\n            responsiveness: definition.responsiveness ?? \"never\",\r\n            widgets: definition.widgets ?? [],\r\n          },\r\n        ];\r\n      }\r\n\r\n      return [\r\n        id,\r\n        {\r\n          ...definition,\r\n          responsiveness: definition.responsiveness ?? \"never\",\r\n        },\r\n      ];\r\n    })\r\n  );\r\n}\r\n\r\nfunction createBuiltinTypes(): Record<\r\n  string,\r\n  CompilationContextCustomTypeDefinition\r\n> {\r\n  return {\r\n    space: {\r\n      type: \"token\",\r\n      responsiveness: \"always\",\r\n      token: \"space\",\r\n      defaultValue: { value: \"0px\" },\r\n      widget: { id: \"@easyblocks/space\", label: \"Space\" },\r\n      allowCustom: true,\r\n      validate(value) {\r\n        return typeof value === \"string\" && !!parseSpacing(value);\r\n      },\r\n    },\r\n    color: {\r\n      type: \"token\",\r\n      responsiveness: \"always\",\r\n      token: \"colors\",\r\n      defaultValue: { value: \"#000000\" },\r\n      widget: { id: \"@easyblocks/color\", label: \"Color\" },\r\n      allowCustom: true,\r\n      validate(value) {\r\n        return typeof value === \"string\" && validateColor(value);\r\n      },\r\n    },\r\n    font: {\r\n      type: \"token\",\r\n      token: \"fonts\",\r\n      responsiveness: \"always\",\r\n      defaultValue: { value: { fontFamily: \"sans-serif\", fontSize: \"16px\" } },\r\n    },\r\n    aspectRatio: {\r\n      type: \"token\",\r\n      token: \"aspectRatios\",\r\n      responsiveness: \"always\",\r\n      widget: { id: \"@easyblocks/aspectRatio\", label: \"Aspect ratio\" },\r\n      defaultValue: { value: \"1:1\" },\r\n      allowCustom: true,\r\n      validate(value) {\r\n        return (\r\n          typeof value === \"string\" &&\r\n          (!!value.match(/[0-9]+:[0-9]+/) || value === \"natural\")\r\n        );\r\n      },\r\n    },\r\n    boxShadow: {\r\n      type: \"token\",\r\n      token: \"boxShadows\",\r\n      responsiveness: \"always\",\r\n      defaultValue: {\r\n        value:\r\n          \"0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)\",\r\n      },\r\n    },\r\n    icon: {\r\n      type: \"token\",\r\n      responsiveness: \"never\",\r\n      token: \"icons\",\r\n      defaultValue: {\r\n        value: `<svg viewBox=\"0 -960 960 960\"><path fill=\"currentColor\" d=\"m480-120-58-52q-101-91-167-157T150-447.5Q111-500 95.5-544T80-634q0-94 63-157t157-63q52 0 99 22t81 62q34-40 81-62t99-22q94 0 157 63t63 157q0 46-15.5 90T810-447.5Q771-395 705-329T538-172l-58 52Zm0-108q96-86 158-147.5t98-107q36-45.5 50-81t14-70.5q0-60-40-100t-100-40q-47 0-87 26.5T518-680h-76q-15-41-55-67.5T300-774q-60 0-100 40t-40 100q0 35 14 70.5t50 81q36 45.5 98 107T480-228Zm0-273Z\"/></svg>`,\r\n      },\r\n      widget: { id: \"@easyblocks/icon\", label: \"Icon\" },\r\n      allowCustom: true,\r\n      validate(value) {\r\n        return typeof value === \"string\" && value.trim().startsWith(\"<svg\");\r\n      },\r\n    },\r\n    text: {\r\n      type: \"external\",\r\n      widgets: [],\r\n    },\r\n  };\r\n}\r\n\r\nfunction ensureDocumentDataWidgetForExternalTypes(\r\n  types: CompilationContextType[\"types\"]\r\n) {\r\n  const externalTypesNames = new Set([\r\n    ...Object.keys(types).filter((t) => types[t].type === \"external\"),\r\n  ]);\r\n\r\n  externalTypesNames.forEach((externalTypeName) => {\r\n    const externalTypeDefinition = types[\r\n      externalTypeName\r\n    ] as ExternalTypeDefinition;\r\n\r\n    if (!externalTypeDefinition.widgets) {\r\n      externalTypeDefinition.widgets = [];\r\n    }\r\n\r\n    const hasDocumentDataWidget = externalTypeDefinition.widgets.some(\r\n      (w) => w.id === \"@easyblocks/document-data\"\r\n    );\r\n\r\n    if (!hasDocumentDataWidget) {\r\n      externalTypeDefinition.widgets.push({\r\n        id: \"@easyblocks/document-data\",\r\n        label: \"Document data\",\r\n      });\r\n    }\r\n  });\r\n}\r\n"],"names":["normalizeSpace","space","responsiveValueMap","val","prepareDevices","configDevices","devices","DEFAULT_DEVICES","forEach","defaultDevice","push","device","index","configDevice","id","w","h","undefined","hidden","startsFrom","previousDevice","breakpoint","createCompilationContext","config","contextParams","rootComponentId","mainDevice","find","x","isMain","Error","customTokens","tokens","theme","value","parseSpacing","unit","$res","themeScalarValueToResponsiveValue","isDefault","label","types","createCustomTypes","createBuiltinTypes","allTypeIds","Object","keys","entries","_ref","type","values","token","fromEntries","map","validate","components","textEditableComponent","richTextEditableComponent","richTextBlockElementEditableComponent","richTextLineElementEditableComponent","richTextPartEditableComponent","schema","prop","visible","rootComponent","component","rootParams","length","ensureDocumentDataWidgetForExternalTypes","builtinTypes","includes","paramSchemaProps","param","typeName","widgets","group","optional","locales","l","code","locale","compilationContext","definitions","mainBreakpointIndex","_ref2","definition","responsiveness","defaultValue","widget","allowCustom","color","validateColor","font","fontFamily","fontSize","aspectRatio","match","boxShadow","icon","trim","startsWith","text","externalTypesNames","Set","filter","t","externalTypeName","externalTypeDefinition","hasDocumentDataWidget","some"],"mappings":"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"}