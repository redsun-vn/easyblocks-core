{"version":3,"file":"definitions.cjs","sources":["../../../src/compiler/definitions.ts"],"sourcesContent":["import { uniqueId } from \"@/utils\";\nimport { SetOptional } from \"type-fest\";\nimport { isLocalValue } from \"..\";\nimport { getFallbackForLocale, getFallbackLocaleForLocale } from \"../locales\";\nimport {\n  isTrulyResponsiveValue,\n  responsiveValueAt,\n  responsiveValueFill,\n  responsiveValueFlatten,\n  responsiveValueMap,\n} from \"../responsiveness\";\nimport {\n  BooleanSchemaProp,\n  CompiledComponentConfig,\n  CompiledLocalTextReference,\n  ComponentCollectionLocalisedSchemaProp,\n  ComponentCollectionSchemaProp,\n  ComponentSchemaProp,\n  Devices,\n  ExternalReference,\n  ExternalReferenceEmpty,\n  ExternalReferenceNonEmpty,\n  ExternalSchemaProp,\n  LocalSchemaProp,\n  LocalTextReference,\n  LocalValue,\n  NoCodeComponentDefinition,\n  NoCodeComponentEntry,\n  NumberSchemaProp,\n  Option,\n  Position,\n  PositionSchemaProp,\n  RadioGroupSchemaProp,\n  ResponsiveValue,\n  SchemaProp,\n  SelectSchemaProp,\n  SerializedComponentDefinitions,\n  StringSchemaProp,\n  TextSchemaProp,\n  ThemeTokenValue,\n  TokenSchemaProp,\n  TokenValue,\n  TrulyResponsiveValue,\n} from \"../types\";\nimport { CompilationCache } from \"./CompilationCache\";\nimport { buildRichTextNoCodeEntry } from \"./builtins/$richText/builders\";\nimport { compileComponent } from \"./compileComponent\";\nimport { getDevicesWidths } from \"./devices\";\nimport {\n  findComponentDefinitionById,\n  findComponentDefinitionsByType,\n} from \"./findComponentDefinition\";\nimport { Component$$$SchemaProp } from \"./schema\";\nimport {\n  CompilationContextType,\n  ContextProps,\n  EditingInfoComponent,\n  EditingInfoComponentCollection,\n} from \"./types\";\n\ntype SchemaPropDefinition<Type, CompiledType = Type> = {\n  compile: (\n    value: Type,\n    contextProps: ContextProps,\n    serializedDefinitions: SerializedComponentDefinitions,\n    editingInfoComponent:\n      | EditingInfoComponent\n      | EditingInfoComponentCollection\n      | undefined,\n    configPrefix: string,\n    cache: CompilationCache\n  ) => CompiledType;\n  normalize: (value: any) => Type; // produces valid internal type\n  getHash: (\n    value: Type,\n    breakpointIndex: string,\n    devices: Devices\n  ) => string | undefined;\n};\n\ntype TextSchemaPropDefinition = SchemaPropDefinition<\n  LocalTextReference | ExternalReference<string>,\n  CompiledLocalTextReference | ExternalReference<string>\n>;\n\ntype StringSchemaPropDefinition = SchemaPropDefinition<\n  ResponsiveValue<string>,\n  ResponsiveValue<string>\n>;\n\ntype NumberSchemaPropDefinition = SchemaPropDefinition<number, number>;\n\ntype BooleanSchemaPropDefinition = SchemaPropDefinition<\n  ResponsiveValue<boolean>,\n  ResponsiveValue<boolean>\n>;\n\ntype SelectSchemaPropDefinition = SchemaPropDefinition<\n  ResponsiveValue<string>,\n  ResponsiveValue<string>\n>;\n\ntype RadioGroupSchemaPropDefinition = SchemaPropDefinition<\n  ResponsiveValue<string>,\n  ResponsiveValue<string>\n>;\n\nexport type ConfigComponentCompilationOutput = {\n  compiledComponentConfig: CompiledComponentConfig;\n  configAfterAuto: NoCodeComponentEntry;\n};\n\ntype ComponentSchemaPropDefinition = SchemaPropDefinition<\n  Array<NoCodeComponentEntry>,\n  Array<ConfigComponentCompilationOutput>\n>;\n\ntype ComponentCollectionSchemaPropDefinition = SchemaPropDefinition<\n  Array<NoCodeComponentEntry>,\n  Array<ConfigComponentCompilationOutput>\n>;\n\ntype ComponentCollectionLocalisedSchemaPropDefinition = SchemaPropDefinition<\n  { [locale: string]: NoCodeComponentEntry[] },\n  Array<ConfigComponentCompilationOutput>\n>;\n\ntype Component$$$SchemaPropDefinition = SchemaPropDefinition<\n  NoCodeComponentEntry,\n  NoCodeComponentEntry\n>;\n\nexport type SchemaPropDefinitionProviders = {\n  text: (\n    schemaProp: TextSchemaProp,\n    compilationContext: CompilationContextType\n  ) => TextSchemaPropDefinition;\n  string: (\n    schemaProp: StringSchemaProp,\n    compilationContext: CompilationContextType\n  ) => StringSchemaPropDefinition;\n  number: (\n    schemaProp: NumberSchemaProp,\n    compilationContext: CompilationContextType\n  ) => NumberSchemaPropDefinition;\n  boolean: (\n    schemaProp: BooleanSchemaProp,\n    compilationContext: CompilationContextType\n  ) => BooleanSchemaPropDefinition;\n  select: (\n    schemaProp: SelectSchemaProp,\n    compilationContext: CompilationContextType\n  ) => SelectSchemaPropDefinition;\n  \"radio-group\": (\n    schemaProp: RadioGroupSchemaProp,\n    compilationContext: CompilationContextType\n  ) => RadioGroupSchemaPropDefinition;\n  component: (\n    schemaProp: ComponentSchemaProp,\n    compilationContext: CompilationContextType\n  ) => ComponentSchemaPropDefinition;\n  \"component-collection\": (\n    schemaProp: ComponentCollectionSchemaProp,\n    compilationContext: CompilationContextType\n  ) => ComponentCollectionSchemaPropDefinition;\n  \"component-collection-localised\": (\n    schemaProp: ComponentCollectionLocalisedSchemaProp,\n    compilationContext: CompilationContextType\n  ) => ComponentCollectionLocalisedSchemaPropDefinition;\n  component$$$: (\n    schemaProp: Component$$$SchemaProp,\n    compilationContext: CompilationContextType\n  ) => Component$$$SchemaPropDefinition;\n  // external: (\n  //   schemaProp: ExternalSchemaProp,\n  //   compilationContext: CompilationContextType\n  // ) => ExternalSchemaPropDefinition;\n  position: (\n    schemaProp: PositionSchemaProp,\n    compilationContext: CompilationContextType\n  ) => SchemaPropDefinition<\n    ResponsiveValue<Position>,\n    ResponsiveValue<Position>\n  >;\n  custom: (\n    schemaProp: ExternalSchemaProp | LocalSchemaProp | TokenSchemaProp,\n    compilationContext: CompilationContextType\n  ) => SchemaPropDefinition<\n    ResponsiveValue<ExternalReference | LocalValue | TokenValue>,\n    ExternalReference | string\n  >;\n};\n\ntype SchemaPropDefinitionProvider =\n  SchemaPropDefinitionProviders[keyof SchemaPropDefinitionProviders];\n\nconst textProvider: SchemaPropDefinitionProviders[\"text\"] = (\n  schemaProp,\n  compilationContext\n) => {\n  const checkIfValid = (x: any) => {\n    if (typeof x !== \"object\" || x === null) {\n      return false;\n    }\n\n    if (typeof x.id === \"string\") {\n      if (x.id.startsWith(\"local.\")) {\n        // for local values \"value\" must be object\n        if (typeof x.value !== \"object\" || x.value === null) {\n          return false;\n        }\n      }\n    }\n\n    return true;\n  };\n\n  return {\n    normalize: (x: any) => {\n      if (x === undefined || x === null) {\n        return {\n          id: \"local.\" + uniqueId(),\n          value: {\n            [compilationContext.contextParams.locale]:\n              schemaProp.defaultValue ?? \"Lorem ipsum\",\n          },\n          widgetId: \"@easyblocks/local-text\",\n        };\n      }\n\n      if (checkIfValid(x)) {\n        return x;\n      }\n\n      throw new Error(`incorrect text type: ${x}`);\n    },\n    compile: (x: any) => {\n      if (\"value\" in x) {\n        const value = x.value[compilationContext.contextParams.locale];\n\n        // Let's apply fallback\n        if (typeof value !== \"string\") {\n          const fallbackValue =\n            getFallbackForLocale(\n              x.value,\n              compilationContext.contextParams.locale,\n              compilationContext.locales\n            ) ?? \"\";\n\n          return {\n            id: x.id,\n            value: fallbackValue,\n            widgetId: \"@easyblocks/local-text\",\n          };\n        }\n\n        return {\n          id: x.id,\n          value,\n          widgetId: \"@easyblocks/local-text\",\n        };\n      }\n\n      return {\n        id: x.id,\n        widgetId: x.widgetId,\n        ...(x.id !== null && { key: x.key }),\n      };\n    },\n    getHash: (value) => {\n      // TODO: those conditions will be removed after we merge external-local texts update\n      if (typeof value === \"string\") {\n        return value;\n      }\n      if (value === null) {\n        return undefined;\n      }\n\n      return value.id ?? undefined;\n    },\n  };\n};\n\nexport const schemaPropDefinitions: SchemaPropDefinitionProviders = {\n  text: textProvider,\n  number: (schemaProp, compilationContext): NumberSchemaPropDefinition => {\n    const normalize = getNormalize(\n      compilationContext,\n      schemaProp.defaultValue,\n      0,\n      (x) => (typeof x === \"number\" ? x : undefined)\n    );\n    return {\n      normalize,\n      compile: (x) => x,\n      getHash: (value) => {\n        return value.toString();\n      },\n    };\n  },\n\n  string: (schemaProp, compilationContext): StringSchemaPropDefinition => {\n    const normalize = schemaProp.responsive\n      ? getResponsiveNormalize(\n        compilationContext,\n        schemaProp.defaultValue,\n        \"\",\n        (x) => (typeof x === \"string\" ? x : undefined)\n      )\n      : getNormalize(compilationContext, schemaProp.defaultValue, \"\", (x) =>\n        typeof x === \"string\" ? x : undefined\n      );\n\n    return {\n      normalize,\n      compile: (x) => x,\n      getHash: (value, breakpointIndex) => {\n        if (isTrulyResponsiveValue(value)) {\n          return responsiveValueAt(value, breakpointIndex);\n        }\n\n        return value;\n      },\n    };\n  },\n\n  boolean: (schemaProp, compilationContext): BooleanSchemaPropDefinition => {\n    const normalize = schemaProp.responsive\n      ? getResponsiveNormalize(\n        compilationContext,\n        schemaProp.defaultValue,\n        false,\n        (x) => (typeof x === \"boolean\" ? x : undefined)\n      )\n      : getNormalize(compilationContext, schemaProp.defaultValue, false, (x) =>\n        typeof x === \"boolean\" ? x : undefined\n      );\n\n    return {\n      normalize,\n      compile: (x) => x,\n      getHash: (value, breakpointIndex) => {\n        if (isTrulyResponsiveValue(value)) {\n          const breakpointValue = responsiveValueAt(value, breakpointIndex);\n          return breakpointValue?.toString();\n        }\n\n        return value.toString();\n      },\n    };\n  },\n\n  select: getSelectSchemaPropDefinition(),\n\n  \"radio-group\": getSelectSchemaPropDefinition(),\n\n  component: (\n    schemaProp,\n    compilationContext: CompilationContextType\n  ): ComponentSchemaPropDefinition => {\n    // Here:\n    // 1. if non-fixed => block field.\n    // 2. if fixed => block field with \"fixed\" flag (no component picker).\n    const normalize = (x: any) => {\n      if (!Array.isArray(x) || x.length === 0) {\n        let componentDefinition: NoCodeComponentDefinition | undefined;\n\n        for (const componentIdOrType of schemaProp.accepts) {\n          componentDefinition = findComponentDefinitionById(\n            componentIdOrType,\n            compilationContext\n          );\n\n          if (!componentDefinition) {\n            const componentDefinitionsByType = findComponentDefinitionsByType(\n              componentIdOrType,\n              compilationContext\n            );\n\n            if (componentDefinitionsByType.length > 0) {\n              componentDefinition = componentDefinitionsByType[0];\n              break;\n            }\n          } else {\n            break;\n          }\n        }\n\n        if (schemaProp.required) {\n          if (!componentDefinition) {\n            throw new Error(\n              `Missing component definition for prop \"${schemaProp.prop\n              }\" for specified accepted types: [${schemaProp.accepts.join(\n                \", \"\n              )}]`\n            );\n          }\n\n          return [\n            normalizeComponent(\n              { _component: componentDefinition.id },\n              compilationContext\n            ),\n          ];\n        }\n\n        return [];\n      }\n\n      return [normalizeComponent(x[0], compilationContext)];\n    };\n\n    return {\n      normalize,\n      compile: (\n        arg,\n        contextProps,\n        serializedDefinitions,\n        editingInfoComponent,\n        configPrefix,\n        cache\n      ) => {\n        if (arg.length === 0) {\n          return [];\n        }\n\n        // FIXME: ?????\n        const { configAfterAuto, compiledComponentConfig } = compileComponent(\n          arg[0] as NoCodeComponentEntry,\n          compilationContext,\n          contextProps,\n          serializedDefinitions || {\n            components: [],\n          },\n          cache,\n          editingInfoComponent,\n          `${configPrefix}.0`\n        );\n\n        return [\n          {\n            configAfterAuto,\n            compiledComponentConfig,\n          },\n        ];\n      },\n      getHash: (value) => {\n        if (value.length > 0) {\n          // For now, if the block's value contains elements, it will only contain single element\n          if (process.env.NODE_ENV === \"development\") {\n            console.assert(\n              value.length === 1,\n              \"component prop should have only one element\"\n            );\n          }\n\n          return value[0]._component;\n        }\n\n        return \"__BLOCK_EMPTY__\";\n      },\n    };\n  },\n\n  \"component-collection\": (\n    _,\n    compilationContext: CompilationContextType\n  ): ComponentCollectionSchemaPropDefinition => {\n    const normalize = (x: any) => {\n      if (!Array.isArray(x)) {\n        return [];\n      }\n      const ret = (x || []).map((item: NoCodeComponentEntry) =>\n        normalizeComponent(item, compilationContext)\n      );\n\n      return ret;\n    };\n\n    return {\n      normalize,\n      compile: (\n        arr,\n        contextProps,\n        serializedDefinitions,\n        editingInfoComponents,\n        configPrefix,\n        cache\n      ) => {\n        return arr.map((componentConfig, index) =>\n          compileComponent(\n            componentConfig as NoCodeComponentEntry,\n            compilationContext,\n            (contextProps.itemProps || [])[index] || {},\n            serializedDefinitions,\n            cache,\n            (\n              editingInfoComponents as\n              | EditingInfoComponentCollection\n              | undefined\n            )?.items?.[index],\n            `${configPrefix}.${index}`\n          )\n        );\n      },\n      getHash: (value) => {\n        return value.map((v) => v._component).join(\";\");\n      },\n    };\n  },\n\n  \"component-collection-localised\": (\n    schemaProp,\n    compilationContext: CompilationContextType\n  ): ComponentCollectionLocalisedSchemaPropDefinition => {\n    const collectionSchemaPropDefinition = schemaPropDefinitions[\n      \"component-collection\"\n    ]({ ...schemaProp, type: \"component-collection\" }, compilationContext);\n\n    return {\n      normalize: (x: any) => {\n        if (x === undefined) {\n          return {};\n        }\n        const normalized: { [locale: string]: NoCodeComponentEntry[] } = {};\n        for (const locale in x) {\n          if (locale === \"__fallback\") {\n            continue;\n          }\n\n          normalized[locale] = collectionSchemaPropDefinition.normalize(\n            x[locale]\n          );\n        }\n\n        return normalized;\n      },\n      compile: (\n        value,\n        contextProps,\n        serializedDefinitions,\n        editingInfoComponents,\n        configPrefix,\n        cache\n      ) => {\n        const resolvedLocalisedValue = resolveLocalisedValue(\n          value,\n          compilationContext\n        );\n\n        return collectionSchemaPropDefinition.compile(\n          resolvedLocalisedValue?.value ?? [],\n          contextProps,\n          serializedDefinitions,\n          editingInfoComponents,\n          `${configPrefix}.${resolvedLocalisedValue?.locale ??\n          compilationContext.contextParams.locale\n          }`,\n          cache\n        );\n      },\n      getHash: (value, breakpoint, devices) => {\n        return collectionSchemaPropDefinition.getHash(\n          value[compilationContext.contextParams.locale] ?? [],\n          breakpoint,\n          devices\n        );\n      },\n    };\n  },\n\n  component$$$: () => {\n    return {\n      normalize: (x) => x,\n      compile: (x) => x,\n      getHash: (x) => x._component,\n    };\n  },\n\n  // external: (schemaProp, compilationContext) => {\n  //   if (schemaProp.responsive) {\n  //     const defaultValue: ExternalReferenceEmpty = {\n  //       id: null,\n  //       widgetId: compilationContext.isEditing\n  //         ? compilationContext.types[schemaProp.type]?.widgets[0]?.id\n  //         : \"\",\n  //     };\n\n  //     const normalize = getResponsiveNormalize<ExternalReference>(\n  //       compilationContext,\n  //       defaultValue,\n  //       defaultValue,\n  //       externalNormalize(schemaProp.type)\n  //     );\n\n  //     return {\n  //       normalize,\n  //       compile: (x) => x,\n  //       getHash: externalReferenceGetHash,\n  //     };\n  //   }\n\n  //   return {\n  //     normalize: (value) => {\n  //       const normalized = externalNormalize(schemaProp.type)(\n  //         value,\n  //         compilationContext\n  //       );\n\n  //       if (!normalized) {\n  //         return {\n  //           id: null,\n  //           widgetId: compilationContext.types[schemaProp.type]?.widgets[0]?.id,\n  //         };\n  //       }\n\n  //       return normalized;\n  //     },\n  //     compile: (value) => {\n  //       return value;\n  //     },\n  //     getHash: (value) => {\n  //       if (value.id === null) {\n  //         return `${schemaProp.type}.${value.widgetId}`;\n  //       }\n\n  //       return `${schemaProp.type}.${value.widgetId}.${value.id}`;\n  //     },\n  //   };\n  // },\n  position: (schemaProp, compilationContext) => {\n    return {\n      normalize: getResponsiveNormalize<Position>(\n        compilationContext,\n        schemaProp.defaultValue,\n        \"top-left\",\n        (x) => {\n          return typeof x === \"string\" ? (x as Position) : \"top-left\";\n        }\n      ),\n      compile: (x) => x,\n      getHash: (value, currentBreakpoint) => {\n        if (isTrulyResponsiveValue(value)) {\n          const breakpointValue = responsiveValueAt(value, currentBreakpoint);\n          return breakpointValue?.toString();\n        }\n\n        return value;\n      },\n    };\n  },\n  custom: (schemaProp, compilationContext) => {\n    const customTypeDefinition = compilationContext.types[schemaProp.type];\n\n    return {\n      normalize: (value) => {\n        if (customTypeDefinition.type === \"inline\") {\n          const defaultValue =\n            schemaProp.defaultValue ?? customTypeDefinition.defaultValue;\n\n          const normalizeScalar = (v: any) => {\n            if (isLocalValue(v)) {\n              if (customTypeDefinition.validate) {\n                const isValueValid = customTypeDefinition.validate(v.value);\n\n                if (isValueValid) {\n                  return v;\n                }\n\n                return {\n                  value: defaultValue,\n                  widgetId: v.widgetId,\n                };\n              }\n\n              return {\n                value: v.value ?? defaultValue,\n                widgetId: v.widgetId,\n              };\n            }\n\n            return {\n              value: v ?? defaultValue,\n              widgetId: customTypeDefinition.widget.id,\n            };\n          };\n\n          if (\n            (customTypeDefinition.responsiveness === \"optional\" &&\n              schemaProp.responsive) ||\n            customTypeDefinition.responsiveness === \"always\"\n          ) {\n            const normalize = getResponsiveNormalize(\n              compilationContext,\n              defaultValue,\n              defaultValue,\n              normalizeScalar\n            );\n\n            return normalize(value);\n          }\n\n          if (\n            customTypeDefinition.responsiveness === \"never\" &&\n            schemaProp.responsive\n          ) {\n            console.warn(\n              `Custom type \"${schemaProp.type}\" is marked as \"never\" responsive, but schema prop is marked as responsive. This is not supported and the value for this field is going to stay not responsive. Please change custom type definition or schema prop definition.`\n            );\n          }\n\n          const result = normalizeScalar(value);\n\n          if (result) {\n            return result;\n          }\n\n          const defaultLocalValue: LocalValue = {\n            value: defaultValue,\n            widgetId: customTypeDefinition.widget.id,\n          };\n\n          return defaultLocalValue;\n        }\n\n        if (customTypeDefinition.type === \"token\") {\n          const themeValues =\n            compilationContext.theme[customTypeDefinition.token];\n          const defaultThemeValueEntry = Object.entries(themeValues).find(\n            ([, v]) => v.isDefault\n          );\n\n          const defaultValue = (() => {\n            if (schemaProp.defaultValue) {\n              return schemaProp.defaultValue;\n            } else if (defaultThemeValueEntry) {\n              return { tokenId: defaultThemeValueEntry[0] };\n            } else {\n              return customTypeDefinition.defaultValue;\n            }\n          })();\n\n          const defaultWidgetId = customTypeDefinition.widget?.id;\n\n          const createTokenNormalizer = (normalizeScalar?: (x: any) => any) => {\n            return customTypeDefinition.responsiveness === \"always\" ||\n              (customTypeDefinition.responsiveness === \"optional\" &&\n                schemaProp.responsive)\n              ? getResponsiveNormalize<any>(\n                compilationContext,\n                schemaProp.defaultValue,\n                customTypeDefinition.defaultValue,\n                (x: any) => {\n                  return normalizeTokenValue(\n                    x,\n                    themeValues as ResponsiveValue<any>,\n                    defaultValue,\n                    defaultWidgetId,\n                    normalizeScalar ?? ((x) => x)\n                  );\n                }\n              )\n              : getNormalize(\n                compilationContext,\n                schemaProp.defaultValue,\n                customTypeDefinition.defaultValue,\n                (x: any) => {\n                  return normalizeTokenValue(\n                    x,\n                    themeValues as ResponsiveValue<any>,\n                    defaultValue,\n                    defaultWidgetId,\n                    normalizeScalar ?? ((x) => x)\n                  );\n                }\n              );\n          };\n\n          if (customTypeDefinition.token === \"space\") {\n            const normalizeSpace = createTokenNormalizer((x) => {\n              if (typeof x === \"number\") {\n                return `${x}px`;\n              }\n\n              const isValidSpacing = customTypeDefinition.validate?.(x) ?? true;\n\n              if (!isValidSpacing) {\n                return;\n              }\n\n              return x;\n            });\n\n            return normalizeSpace(value);\n          }\n\n          if (customTypeDefinition.token === \"icons\") {\n            const scalarValueNormalize = (x: any) => {\n              if (typeof x === \"string\" && x.trim().startsWith(\"<svg\")) {\n                return x;\n              }\n              return;\n            };\n\n            const iconDefaultValue =\n              normalizeTokenValue<string>(\n                schemaProp.defaultValue,\n                themeValues as Record<string, ThemeTokenValue<string>>,\n                customTypeDefinition.defaultValue,\n                defaultWidgetId,\n                scalarValueNormalize\n              ) ?? customTypeDefinition.defaultValue;\n\n            return (\n              normalizeTokenValue<string>(\n                value,\n                themeValues as Record<string, ThemeTokenValue<string>>,\n                iconDefaultValue,\n                defaultWidgetId,\n                scalarValueNormalize\n              ) ?? value\n            );\n          }\n\n          const defaultTokenNormalizer = createTokenNormalizer();\n\n          return defaultTokenNormalizer(value);\n        }\n\n        if (customTypeDefinition.type === \"external\") {\n          if (schemaProp.responsive) {\n            const defaultValue: ExternalReferenceEmpty = {\n              id: null,\n              widgetId: compilationContext.isEditing\n                ? customTypeDefinition.widgets[0]?.id\n                : \"\",\n            };\n\n            const normalize = getResponsiveNormalize<ExternalReference>(\n              compilationContext,\n              defaultValue,\n              defaultValue,\n              externalNormalize(schemaProp.type)\n            );\n\n            return normalize(value);\n          }\n\n          const normalized = externalNormalize(schemaProp.type)(\n            value,\n            compilationContext\n          );\n\n          if (!normalized) {\n            return {\n              id: null,\n              widgetId: customTypeDefinition.widgets[0]?.id,\n            };\n          }\n\n          return normalized;\n        }\n\n        throw new Error(\"Unknown type definition\");\n      },\n      compile: (x) => {\n        const val = responsiveValueMap(x, (y) => {\n          if (\"value\" in y) {\n            return y.value;\n          }\n\n          return y;\n        });\n\n        const flattened = responsiveValueFlatten(\n          val,\n          compilationContext.devices\n        );\n\n        return responsiveValueFill(\n          flattened,\n          compilationContext.devices,\n          getDevicesWidths(compilationContext.devices)\n        );\n      },\n      getHash: (value, breakpointIndex) => {\n        function getTokenValue(value: TokenValue) {\n          if (value.tokenId) {\n            return value.tokenId;\n          }\n\n          if (typeof value.value === \"object\") {\n            return JSON.stringify(value.value);\n          }\n\n          const scalarVal: any = value.value;\n\n          if (scalarVal.toString) {\n            return scalarVal.toString();\n          }\n\n          throw new Error(\"unreachable\");\n        }\n\n        if (customTypeDefinition.type === \"external\") {\n          return externalReferenceGetHash(\n            value as ResponsiveValue<ExternalReference>,\n            breakpointIndex\n          );\n        }\n\n        if (isTrulyResponsiveValue(value)) {\n          const breakpointValue = responsiveValueAt(\n            value as TrulyResponsiveValue<LocalValue | TokenValue>,\n            breakpointIndex\n          );\n\n          if (!breakpointValue) {\n            return;\n          }\n\n          if (\"tokenId\" in breakpointValue) {\n            return getTokenValue(breakpointValue);\n          }\n\n          return typeof breakpointValue.value === \"object\"\n            ? JSON.stringify(breakpointValue.value)\n            : breakpointValue.value;\n        }\n\n        if (\"tokenId\" in value) {\n          return getTokenValue(value);\n        }\n\n        return typeof (value as LocalValue).value === \"object\"\n          ? JSON.stringify((value as LocalValue).value)\n          : (value as LocalValue).value;\n      },\n    };\n  },\n};\n\nfunction getNormalize<T>(\n  compilationContext: CompilationContextType,\n  defaultValue: any,\n  fallbackDefaultValue: T,\n  normalize: (\n    x: any,\n    compilationContext: CompilationContextType\n  ) => T | undefined = (x) => x\n) {\n  return (val: any): T => {\n    const normalizedVal = normalize(val, compilationContext);\n    if (normalizedVal !== undefined) {\n      return normalizedVal;\n    }\n\n    const normalizedDefaultVal = normalize(defaultValue, compilationContext);\n    if (normalizedDefaultVal !== undefined) {\n      return normalizedDefaultVal;\n    }\n\n    return normalize(fallbackDefaultValue, compilationContext) as T;\n  };\n}\n\nfunction getResponsiveNormalize<ScalarType>(\n  compilationContext: CompilationContextType,\n  defaultValue: any,\n  fallbackDefaultValue: ScalarType,\n  normalize: (\n    x: any,\n    compilationContext: CompilationContextType\n  ) => ScalarType | undefined = (x) => x\n) {\n  if (isTrulyResponsiveValue(defaultValue)) {\n    /**\n     * Here we must decide how this behaves. It's not obvious. If default is responsive, we cannot easily use default breakpoints.\n     * It's because auto might be different. Changing one breakpoint changes \"context\" for others.\n     */\n    throw new Error(\"default responsive values not yet supported\");\n  }\n\n  return (val: any): TrulyResponsiveValue<ScalarType> => {\n    const scalarNormalize = getNormalize(\n      compilationContext,\n      defaultValue,\n      fallbackDefaultValue,\n      normalize\n    );\n\n    // if value is not really responsive\n    if (!isTrulyResponsiveValue(val)) {\n      return {\n        $res: true,\n        [compilationContext.mainBreakpointIndex]: scalarNormalize(val),\n      };\n    }\n\n    const responsiveVal = responsiveValueMap(val, (x) => {\n      return normalize(x, compilationContext);\n    });\n\n    // main breakpoint always set\n    if (responsiveVal[compilationContext.mainBreakpointIndex] === undefined) {\n      responsiveVal[compilationContext.mainBreakpointIndex] =\n        scalarNormalize(undefined);\n    }\n\n    return responsiveVal as TrulyResponsiveValue<ScalarType>;\n  };\n}\n\nfunction getSelectSchemaPropDefinition() {\n  return (\n    schemaProp: SelectSchemaProp | RadioGroupSchemaProp,\n    compilationContext: CompilationContextType\n  ): SelectSchemaPropDefinition => {\n    return {\n      normalize: schemaProp.responsive\n        ? getResponsiveNormalize(\n          compilationContext,\n          schemaProp.defaultValue,\n          getFirstOptionValue(schemaProp),\n          (x) => {\n            return isSelectValueCorrect(x, schemaProp.params.options)\n              ? x\n              : undefined;\n          }\n        )\n        : getNormalize(\n          compilationContext,\n          schemaProp.defaultValue,\n          getFirstOptionValue(schemaProp),\n          (x) => {\n            return isSelectValueCorrect(x, schemaProp.params.options)\n              ? x\n              : undefined;\n          }\n        ),\n      compile: (x) => x,\n      getHash: (value, currentBreakpoint) => {\n        if (isTrulyResponsiveValue(value)) {\n          const breakpointValue = responsiveValueAt(value, currentBreakpoint);\n          return breakpointValue?.toString();\n        }\n\n        return value;\n      },\n    };\n  };\n}\n\nfunction isSelectValueCorrect(value: any, options: Array<Option | string>) {\n  if (typeof value !== \"string\") {\n    return false;\n  }\n  return options.map(getSelectValue).indexOf(value) > -1;\n}\n\nfunction getSelectValue(arg: string | Option): string {\n  if (typeof arg === \"string\") {\n    return arg;\n  }\n\n  return arg.value;\n}\n\nfunction getFirstOptionValue(\n  schemaProp: SelectSchemaProp | RadioGroupSchemaProp\n) {\n  if (schemaProp.params.options.length === 0) {\n    throw new Error(\"Select field can't have 0 options\");\n  }\n\n  const firstOption: string | Option = schemaProp.params.options[0];\n  const firstOptionValue: string =\n    typeof firstOption === \"object\" ? firstOption.value : firstOption;\n\n  return firstOptionValue;\n}\n\nfunction normalizeTokenValue<T>(\n  x: any,\n  themeValues: { [key: string]: ThemeTokenValue<T> },\n  defaultValue: { tokenId: string } | { value: any },\n  defaultWidgetId: string | undefined,\n  scalarValueNormalize: (x: any) => T | undefined = (x) => undefined\n): TokenValue<T> | undefined {\n  const input = x ?? defaultValue;\n  const widgetId = input.widgetId ?? defaultWidgetId;\n\n  // if (typeof input !== \"object\" && \"value\" in defaultValue) {\n  //   const normalizedVal = scalarValueNormalize(defaultValue.value);\n\n  //   if (normalizedVal !== undefined) {\n  //     return {\n  //       value: normalizedVal,\n  //       widgetId,\n  //     };\n  //   }\n\n  //   return;\n  // }\n\n  const hasTokenId = \"tokenId\" in input && typeof input.tokenId === \"string\";\n\n  if (hasTokenId) {\n    const val = themeValues[input.tokenId];\n\n    if (val !== undefined) {\n      return {\n        value: val.value,\n        tokenId: input.tokenId,\n        widgetId,\n      };\n    }\n  }\n\n  if (\"value\" in input) {\n    const normalizedVal = scalarValueNormalize(input.value);\n\n    if (normalizedVal !== undefined) {\n      return {\n        tokenId: hasTokenId ? input.tokenId : undefined,\n        value: normalizedVal,\n        widgetId,\n      };\n    }\n  }\n\n  return;\n}\n\nfunction externalNormalize(\n  externalType: string\n): (\n  x: any,\n  compilationContext: CompilationContextType\n) => ExternalReference | undefined {\n  return (x, compilationContext) => {\n    if (typeof x === \"object\" && x !== null) {\n      if (\"id\" in x && x.id !== null) {\n        const normalized: ExternalReferenceNonEmpty = {\n          id: x.id,\n          widgetId: x.widgetId,\n          key: x.key,\n        };\n\n        return normalized;\n      }\n\n      const normalized: ExternalReferenceEmpty = {\n        id: null,\n        widgetId:\n          typeof x.widgetId === \"string\"\n            ? x.widgetId\n            : (\n              compilationContext.types[externalType] as\n              | Extract<\n                CompilationContextType[\"types\"][string],\n                { type: \"external\" }\n              >\n              | undefined\n            )?.widgets[0]?.id,\n      };\n\n      return normalized;\n    }\n  };\n}\n\nfunction externalReferenceGetHash(\n  value: ResponsiveValue<ExternalReference>,\n  breakpointIndex: string\n): string | undefined {\n  if (isTrulyResponsiveValue(value)) {\n    const breakpointValue = responsiveValueAt(value, breakpointIndex);\n\n    if (breakpointValue) {\n      return externalReferenceGetHash(breakpointValue, breakpointIndex);\n    }\n\n    return;\n  }\n\n  if (value.id) {\n    return `${value.id}.${value.widgetId}`;\n  }\n}\n\nexport function normalizeComponent(\n  configComponent: SetOptional<NoCodeComponentEntry, \"_id\">,\n  compilationContext: CompilationContextType\n): NoCodeComponentEntry {\n  const ret: NoCodeComponentEntry = {\n    _id: configComponent._id ?? uniqueId(),\n    _component: configComponent._component,\n  };\n\n  // Normalize itemProps (before own props). If component definition is missing, we still normalize item props\n  if (configComponent._itemProps) {\n    ret._itemProps = {};\n\n    for (const templateId in configComponent._itemProps) {\n      ret._itemProps[templateId] = {};\n\n      for (const fieldName in configComponent._itemProps[templateId]) {\n        ret._itemProps[templateId][fieldName] = {};\n\n        const values = configComponent._itemProps[templateId][fieldName];\n\n        const ownerDefinition = findComponentDefinitionById(\n          templateId,\n          compilationContext\n        )!;\n        const ownerSchemaProp = ownerDefinition.schema.find(\n          (x) => x.prop === fieldName\n        ) as ComponentCollectionSchemaProp | undefined;\n\n        if (!ownerSchemaProp) {\n          continue;\n        }\n\n        (ownerSchemaProp.itemFields || []).forEach((itemFieldSchemaProp) => {\n          ret._itemProps[templateId][fieldName][itemFieldSchemaProp.prop] =\n            getSchemaDefinition(\n              itemFieldSchemaProp,\n              compilationContext\n            ).normalize(values[itemFieldSchemaProp.prop]);\n        });\n      }\n    }\n  }\n\n  const componentDefinition = findComponentDefinitionById(\n    configComponent._component,\n    compilationContext\n  );\n\n  if (!componentDefinition) {\n    console.warn(\n      `[normalize] Unknown _component ${configComponent._component}`\n    );\n    return ret;\n  }\n\n  componentDefinition.schema.forEach((schemaProp) => {\n    ret[schemaProp.prop] = getSchemaDefinition(\n      schemaProp,\n      compilationContext\n    ).normalize(configComponent[schemaProp.prop]);\n  });\n\n  // RichText is a really specific component. It must have concrete shape to work properly.\n  // When using prop of type `component` with `accepts: [\"@easyblocks/rich-text\"]` it's going to be initialized with empty\n  // `elements` property which in result will cause RichText to not work properly. To fix this, we're going\n  // to initialize `elements` with default template - the same that's being added when user adds RichText to Stack manually.\n  if (ret._component === \"@easyblocks/rich-text\") {\n    if (\n      Object.keys(ret.elements).length === 0 ||\n      ret.elements[compilationContext.contextParams.locale]?.length === 0\n    ) {\n      const richTextConfig = buildRichTextNoCodeEntry({\n        locale: compilationContext.contextParams.locale,\n        color: Object.entries(compilationContext.theme.colors ?? {}).find(\n          ([, value]) => value.isDefault\n        )?.[0],\n        font: Object.entries(compilationContext.theme.fonts ?? {}).find(\n          ([, value]) => value.isDefault\n        )?.[0],\n      });\n\n      ret.elements = richTextConfig.elements;\n    }\n  }\n\n  return ret;\n}\n\nexport function getSchemaDefinition<\n  T extends SchemaProp | Component$$$SchemaProp\n>(\n  schemaProp: T,\n  compilationContext: CompilationContextType\n): ReturnType<SchemaPropDefinitionProvider> {\n  const provider =\n    compilationContext.types[schemaProp.type] && schemaProp.type !== \"text\"\n      ? schemaPropDefinitions.custom\n      : schemaPropDefinitions[schemaProp.type as keyof SchemaPropDefinitionProviders];\n\n  return provider(schemaProp as any, compilationContext);\n}\n\nexport function resolveLocalisedValue<T>(\n  localisedValue: Record<string, T>,\n  compilationContext: CompilationContextType\n): { value: T; locale: string } | undefined {\n  const locale = compilationContext.contextParams.locale;\n\n  if (localisedValue[locale] !== undefined) {\n    return {\n      value: localisedValue[locale],\n      locale,\n    };\n  }\n\n  const fallbackLocale = getFallbackLocaleForLocale(\n    locale,\n    compilationContext.locales\n  );\n  if (!fallbackLocale) {\n    return;\n  }\n  return {\n    value: localisedValue[fallbackLocale],\n    locale: fallbackLocale,\n  };\n}\n"],"names":["textProvider","schemaProp","compilationContext","checkIfValid","x","id","startsWith","value","normalize","undefined","uniqueId","contextParams","locale","defaultValue","widgetId","Error","compile","fallbackValue","getFallbackForLocale","locales","key","getHash","schemaPropDefinitions","text","number","getNormalize","toString","string","responsive","getResponsiveNormalize","breakpointIndex","isTrulyResponsiveValue","responsiveValueAt","boolean","breakpointValue","select","getSelectSchemaPropDefinition","component","Array","isArray","length","componentDefinition","componentIdOrType","accepts","findComponentDefinitionById","componentDefinitionsByType","findComponentDefinitionsByType","required","prop","join","normalizeComponent","_component","arg","contextProps","serializedDefinitions","editingInfoComponent","configPrefix","cache","configAfterAuto","compiledComponentConfig","compileComponent","components","process","env","NODE_ENV","console","assert","component-collection","_","ret","map","item","arr","editingInfoComponents","componentConfig","index","itemProps","items","v","component-collection-localised","collectionSchemaPropDefinition","type","normalized","resolvedLocalisedValue","resolveLocalisedValue","breakpoint","devices","component$$$","position","currentBreakpoint","custom","customTypeDefinition","types","normalizeScalar","isLocalValue","validate","isValueValid","widget","responsiveness","warn","result","defaultLocalValue","themeValues","theme","token","defaultThemeValueEntry","Object","entries","find","_ref","isDefault","tokenId","defaultWidgetId","createTokenNormalizer","normalizeTokenValue","normalizeSpace","isValidSpacing","scalarValueNormalize","trim","iconDefaultValue","defaultTokenNormalizer","isEditing","widgets","externalNormalize","val","responsiveValueMap","y","flattened","responsiveValueFlatten","responsiveValueFill","getDevicesWidths","getTokenValue","JSON","stringify","scalarVal","externalReferenceGetHash","fallbackDefaultValue","arguments","normalizedVal","normalizedDefaultVal","scalarNormalize","$res","mainBreakpointIndex","responsiveVal","getFirstOptionValue","isSelectValueCorrect","params","options","getSelectValue","indexOf","firstOption","firstOptionValue","input","hasTokenId","externalType","configComponent","_id","_itemProps","templateId","fieldName","values","ownerDefinition","ownerSchemaProp","schema","itemFields","forEach","itemFieldSchemaProp","getSchemaDefinition","keys","elements","richTextConfig","buildRichTextNoCodeEntry","color","colors","_ref2","font","fonts","_ref3","provider","localisedValue","fallbackLocale","getFallbackLocaleForLocale"],"mappings":"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"}