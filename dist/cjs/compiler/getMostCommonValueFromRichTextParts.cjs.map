{"version":3,"file":"getMostCommonValueFromRichTextParts.cjs","sources":["../../../src/compiler/getMostCommonValueFromRichTextParts.ts"],"sourcesContent":["import { entries } from \"@/utils\";\nimport { getFallbackForLocale } from \"../locales\";\nimport { DeviceRange } from \"../types\";\nimport { CompilationCache } from \"./CompilationCache\";\nimport { RichTextComponentConfig } from \"./builtins/$richText/$richText\";\nimport { RichTextBlockElementComponentConfig } from \"./builtins/$richText/$richTextBlockElement/$richTextBlockElement\";\nimport {\n  RichTextPartComponentConfig,\n  richTextPartEditableComponent,\n} from \"./builtins/$richText/$richTextPart/$richTextPart\";\nimport { compileComponentValues } from \"./compileComponentValues\";\nimport { findComponentDefinitionById } from \"./findComponentDefinition\";\nimport { CompilationContextType, InternalComponentDefinition } from \"./types\";\n\n/**\n * Returns the most common value for given `prop` parameter among all @easyblocks/rich-text-part components from `richTextComponentConfig`.\n */\nfunction getMostCommonValueFromRichTextParts<\n  RichTextPartProperty extends Extract<\n    keyof RichTextPartComponentConfig,\n    \"color\" | \"font\"\n  >\n>(\n  richTextComponentConfig: RichTextComponentConfig,\n  prop: RichTextPartProperty,\n  compilationContext: CompilationContextType,\n  cache: CompilationCache\n) {\n  const richTextBlockElements:\n    | Array<RichTextBlockElementComponentConfig>\n    | undefined =\n    richTextComponentConfig.elements[compilationContext.contextParams.locale] ??\n    getFallbackForLocale(\n      richTextComponentConfig.elements,\n      compilationContext.contextParams.locale,\n      compilationContext.locales\n    );\n\n  if (!richTextBlockElements) {\n    return;\n  }\n\n  const richTextParts = richTextBlockElements.flatMap((blockElement) => {\n    return blockElement.elements.flatMap((lineElement) => {\n      return lineElement.elements;\n    });\n  });\n\n  const richTextPartComponentDefinition = findComponentDefinitionById(\n    richTextPartEditableComponent.id,\n    compilationContext\n  )!;\n\n  const deviceIdToRichTextPartValuesGroupedByPropValue = Object.fromEntries(\n    compilationContext.devices\n      .map((device) => {\n        const richTextPartsCompiledPropValues = richTextParts.flatMap(\n          (richTextPart) => {\n            return mapRichTextPartToCompiledPropValue(\n              richTextPart,\n              richTextPartComponentDefinition,\n              compilationContext,\n              prop,\n              cache\n            );\n          }\n        );\n\n        const richTextPartValuesLengthGroupedByPropValue =\n          richTextPartsCompiledPropValues.reduce(\n            (acc, current) =>\n              groupTotalValueLengthByCompiledPropValue<RichTextPartProperty>(\n                prop,\n                device\n              )(acc, current),\n            {} as Record<string, number>\n          );\n\n        return [device.id, richTextPartValuesLengthGroupedByPropValue] as const;\n      })\n      .filter((entry) => Object.keys(entry[1]).length > 0)\n      .map((entry) => {\n        return [\n          entry[0],\n          getCompiledValueFromEntryWithMaxTotalValueLength(entry),\n        ];\n      })\n  );\n\n  if (\n    Object.keys(deviceIdToRichTextPartValuesGroupedByPropValue).length === 0\n  ) {\n    return;\n  }\n\n  return { $res: true, ...deviceIdToRichTextPartValuesGroupedByPropValue };\n}\n\nexport { getMostCommonValueFromRichTextParts };\n\nfunction getCompiledValueFromEntryWithMaxTotalValueLength(\n  entry: readonly [string, Record<string, number>]\n): any {\n  const compiledPropValue = entries(entry[1]).reduce((maxEntry, currentEntry) =>\n    currentEntry[1] > maxEntry[1] ? currentEntry : maxEntry\n  )[0];\n\n  try {\n    return JSON.parse(compiledPropValue);\n  } catch {\n    return compiledPropValue;\n  }\n}\n\nfunction groupTotalValueLengthByCompiledPropValue<\n  RichTextPartProperty extends Extract<\n    keyof RichTextPartComponentConfig,\n    \"color\" | \"font\"\n  >\n>(\n  prop: RichTextPartProperty,\n  device: DeviceRange\n): (\n  previousValue: Record<string, number>,\n  currentValue: { [x: string]: any; value: string }\n) => Record<string, number> {\n  return (acc, current) => {\n    const key = JSON.stringify(current[prop][device.id]);\n\n    if (key === undefined) {\n      return acc;\n    }\n\n    if (!acc[key]) {\n      acc[key] = 0;\n    }\n\n    acc[key] += current.value.length;\n    return acc;\n  };\n}\n\nfunction mapRichTextPartToCompiledPropValue(\n  richTextPart: RichTextPartComponentConfig,\n  richTextPartComponentDefinition: InternalComponentDefinition,\n  compilationContext: CompilationContextType,\n  prop: string,\n  cache: CompilationCache\n) {\n  const compiledValues = compileComponentValues(\n    richTextPart,\n    richTextPartComponentDefinition,\n    compilationContext,\n    cache\n  );\n\n  return {\n    value: richTextPart.value,\n    [prop]: compiledValues[prop],\n  };\n}\n"],"names":["getMostCommonValueFromRichTextParts","richTextComponentConfig","prop","compilationContext","cache","richTextBlockElements","elements","contextParams","locale","getFallbackForLocale","locales","richTextParts","flatMap","blockElement","lineElement","richTextPartComponentDefinition","findComponentDefinitionById","richTextPartEditableComponent","id","deviceIdToRichTextPartValuesGroupedByPropValue","Object","fromEntries","devices","map","device","richTextPartsCompiledPropValues","richTextPart","mapRichTextPartToCompiledPropValue","richTextPartValuesLengthGroupedByPropValue","reduce","acc","current","groupTotalValueLengthByCompiledPropValue","filter","entry","keys","length","getCompiledValueFromEntryWithMaxTotalValueLength","$res","compiledPropValue","entries","maxEntry","currentEntry","JSON","parse","key","stringify","undefined","value","compiledValues","compileComponentValues"],"mappings":"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"}