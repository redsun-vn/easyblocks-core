{"version":3,"file":"useTextValue.cjs","sources":["../../../../src/compiler/builtins/useTextValue.ts"],"sourcesContent":["import { cleanString } from \"@/utils\";\nimport debounce from \"lodash/debounce\";\nimport React from \"react\";\nimport { Locale, getFallbackForLocale } from \"../../locales\";\n\nexport function useTextValue(\n  value: any,\n  onChange: any,\n  locale: string,\n  locales: Array<Locale>,\n  defaultPlaceholder?: string,\n  normalize?: (x: string) => string | null\n) {\n  const isExternal = typeof value === \"object\" && value !== null;\n  const fallbackValue = isExternal\n    ? getFallbackForLocale(value.value, locale, locales)\n    : undefined;\n\n  const valueFromProps = (() => {\n    if (isExternal) {\n      let displayedValue = value.value?.[locale];\n\n      if (typeof displayedValue !== \"string\") {\n        displayedValue = fallbackValue ?? \"\";\n      }\n\n      return displayedValue;\n    }\n    return value ?? \"\";\n  })();\n\n  const previousValue = React.useRef(valueFromProps);\n\n  const [localInputValue, setLocalInputValue] = React.useState(valueFromProps);\n\n  function saveNewValue(newValue: string | null) {\n    if (isExternal) {\n      const newExternalValue = {\n        ...value,\n        value: {\n          ...value.value,\n          [locale]: newValue,\n        },\n      };\n\n      onChange(newExternalValue);\n    } else {\n      onChange(newValue);\n    }\n  }\n\n  const onChangeDebounced = React.useCallback(\n    debounce((newValue: string) => {\n      // If normalization is on, we shouldn't save on change\n      if (normalize) {\n        return;\n      }\n\n      saveNewValue(newValue);\n    }, 500),\n    [isExternal]\n  );\n\n  function handleBlur() {\n    onChangeDebounced.cancel();\n\n    let newValue = localInputValue;\n\n    if (normalize) {\n      const normalized = normalize(newValue);\n      if (normalized === null) {\n        newValue = previousValue.current;\n      } else {\n        newValue = normalized;\n        previousValue.current = localInputValue;\n      }\n    }\n\n    setLocalInputValue(newValue);\n\n    if (isExternal) {\n      if (newValue.trim() === \"\") {\n        saveNewValue(null);\n        setLocalInputValue(fallbackValue ?? \"\");\n      } else {\n        saveNewValue(newValue);\n      }\n    } else {\n      if (value !== newValue) {\n        saveNewValue(newValue);\n      }\n    }\n  }\n\n  function handleChange(\n    event: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>\n  ) {\n    setLocalInputValue(event.target.value);\n    onChangeDebounced(event.target.value);\n  }\n\n  // Sync local value with value from the config if the field value has been\n  // changed from outside\n  React.useEffect(() => {\n    setLocalInputValue(valueFromProps);\n  }, [valueFromProps]);\n\n  const style: any = {\n    opacity: localInputValue === fallbackValue ? 0.5 : 1,\n  };\n\n  return {\n    onChange: handleChange,\n    onBlur: handleBlur,\n    value: cleanString(localInputValue),\n    style,\n    placeholder: defaultPlaceholder ?? \"Enter text\",\n  };\n}\n"],"names":["useTextValue","value","onChange","locale","locales","defaultPlaceholder","normalize","isExternal","fallbackValue","getFallbackForLocale","undefined","valueFromProps","displayedValue","previousValue","React","useRef","localInputValue","setLocalInputValue","useState","saveNewValue","newValue","newExternalValue","onChangeDebounced","useCallback","debounce","handleBlur","cancel","normalized","current","trim","handleChange","event","target","useEffect","style","opacity","onBlur","cleanString","placeholder"],"mappings":"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"}