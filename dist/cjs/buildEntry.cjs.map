{"version":3,"file":"buildEntry.cjs","sources":["../../src/buildEntry.ts"],"sourcesContent":["import { isLocalTextReference } from \"./resourcesUtils\";\r\nimport type {\r\n  RequestedExternalData,\r\n  CompilationMetadata,\r\n  CompiledShopstoryComponentConfig,\r\n  CompilerModule,\r\n  NoCodeComponentEntry,\r\n  Config,\r\n  ExternalData,\r\n  ExternalParams,\r\n  ExternalReference,\r\n  ExternalSchemaProp,\r\n  ExternalWithSchemaProp,\r\n} from \"./types\";\r\nimport { compile, findExternals, validate } from \"./compiler\";\r\n\r\ntype BuildEntryOptions = {\r\n  entry: NoCodeComponentEntry;\r\n  config: Config;\r\n  locale: string;\r\n  compiler?: CompilerModule;\r\n  externalData?: ExternalData;\r\n  isExternalDataChanged?: (\r\n    externalData: {\r\n      id: string;\r\n      externalId: ExternalReference[\"id\"];\r\n    },\r\n    defaultIsExternalDataChanged: (externalData: {\r\n      id: string;\r\n      externalId: ExternalReference[\"id\"];\r\n    }) => boolean\r\n  ) => boolean;\r\n};\r\n\r\nconst defaultCompiler: CompilerModule = {\r\n  compile,\r\n  findExternals,\r\n  validate,\r\n};\r\n\r\nfunction buildEntry({\r\n  entry,\r\n  config,\r\n  locale,\r\n  compiler = defaultCompiler,\r\n  externalData = {},\r\n  isExternalDataChanged,\r\n}: BuildEntryOptions): {\r\n  renderableContent: CompiledShopstoryComponentConfig;\r\n  meta: CompilationMetadata;\r\n  externalData: RequestedExternalData;\r\n  configAfterAuto?: NoCodeComponentEntry;\r\n} {\r\n  if (!compiler.validate(entry)) {\r\n    throw new Error(\"Invalid entry\");\r\n  }\r\n\r\n  const contextParams = { locale };\r\n  const compilationResult = compiler.compile(entry, config, contextParams);\r\n  const resourcesWithSchemaProps = compiler.findExternals(\r\n    entry,\r\n    config,\r\n    contextParams\r\n  );\r\n\r\n  const pendingExternalData = findChangedExternalData(\r\n    resourcesWithSchemaProps,\r\n    externalData,\r\n    isExternalDataChanged\r\n  );\r\n\r\n  return {\r\n    renderableContent: compilationResult.compiled,\r\n    meta: compilationResult.meta,\r\n    externalData: pendingExternalData,\r\n    configAfterAuto: compilationResult.configAfterAuto,\r\n  };\r\n}\r\n\r\nexport { buildEntry };\r\n\r\nfunction findChangedExternalData(\r\n  resourcesWithSchemaProps: Array<ExternalWithSchemaProp>,\r\n  externalData: ExternalData,\r\n  isExternalDataPending: BuildEntryOptions[\"isExternalDataChanged\"]\r\n) {\r\n  const changedExternalData: RequestedExternalData = {};\r\n\r\n  function defaultIsExternalDataPending(\r\n    id: string,\r\n    resource: { id: string; externalId: ExternalReference[\"id\"] },\r\n    type: string\r\n  ) {\r\n    // If null, then it's empty external value and it's not pending\r\n    if (resource.externalId === null) {\r\n      return false;\r\n    }\r\n\r\n    // If it's already fetched, then it's not pending\r\n    if (externalData[id]) {\r\n      return false;\r\n    }\r\n\r\n    // If id is a string and it's either local text reference or a reference to document's data, then it's not pending\r\n    if (\r\n      typeof resource.externalId === \"string\" &&\r\n      (isLocalTextReference(\r\n        {\r\n          id: resource.externalId,\r\n        },\r\n        type\r\n      ) ||\r\n        resource.externalId.startsWith(\"$.\"))\r\n    ) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  resourcesWithSchemaProps.forEach(({ id, externalReference, schemaProp }) => {\r\n    const params = getExternalTypeParams(schemaProp);\r\n\r\n    const externalData = {\r\n      id,\r\n      externalId: externalReference.id,\r\n    };\r\n\r\n    if (isExternalDataPending) {\r\n      if (\r\n        !isExternalDataPending(externalData, (resource) => {\r\n          return defaultIsExternalDataPending(id, resource, schemaProp.type);\r\n        })\r\n      ) {\r\n        return;\r\n      }\r\n    } else {\r\n      const isPendingDefault = defaultIsExternalDataPending(\r\n        id,\r\n        externalData,\r\n        schemaProp.type\r\n      );\r\n\r\n      if (!isPendingDefault) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (changedExternalData[id]) {\r\n      return;\r\n    }\r\n\r\n    changedExternalData[id] = {\r\n      id: externalReference.id,\r\n      widgetId: externalReference.widgetId,\r\n      params,\r\n    };\r\n  });\r\n\r\n  return changedExternalData;\r\n}\r\n\r\nfunction getExternalTypeParams(\r\n  schemaProp: ExternalSchemaProp\r\n): ExternalParams | undefined {\r\n  if (schemaProp.type === \"text\") {\r\n    return;\r\n  }\r\n\r\n  return schemaProp.params;\r\n}\r\n"],"names":["defaultCompiler","compile","findExternals","validate","buildEntry","_ref","entry","config","locale","compiler","externalData","isExternalDataChanged","Error","contextParams","compilationResult","resourcesWithSchemaProps","pendingExternalData","findChangedExternalData","renderableContent","compiled","meta","configAfterAuto","isExternalDataPending","changedExternalData","defaultIsExternalDataPending","id","resource","type","externalId","isLocalTextReference","startsWith","forEach","_ref2","externalReference","schemaProp","params","getExternalTypeParams","isPendingDefault","widgetId"],"mappings":"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"}